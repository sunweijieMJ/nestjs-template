name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (default: main)'
        required: false
        default: 'main'

jobs:
  deploy:
    name: Deploy to ECS
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.2.0
        env:
          DEPLOY_PATH: ${{ secrets.ALIYUN_DEPLOY_PATH }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git
          BRANCH: ${{ github.event.inputs.branch || 'main' }}
          TAG: ${{ github.ref_name }}
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          port: ${{ secrets.ALIYUN_PORT || 22 }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          envs: DEPLOY_PATH,REPO_URL,BRANCH,TAG
          script: |
            set -e

            cd "$DEPLOY_PATH"

            # åˆ¤æ–­æ˜¯å¦é¦–æ¬¡éƒ¨ç½²
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ First deployment, cloning repository..."
              cd ..
              rm -rf "$(basename $DEPLOY_PATH)"
              git clone "$REPO_URL" "$(basename $DEPLOY_PATH)"
              cd "$DEPLOY_PATH"
            fi

            echo "ğŸ“¥ Pulling latest code..."
            git fetch --all --tags

            # å¦‚æœæ˜¯ tag è§¦å‘ï¼Œåˆ‡æ¢åˆ° tagï¼›å¦åˆ™åˆ‡æ¢åˆ°åˆ†æ”¯
            if [[ "$TAG" == v* ]]; then
              echo "ğŸ·ï¸ Checking out tag: $TAG"
              git checkout "$TAG"
            else
              echo "ğŸŒ¿ Checking out branch: $BRANCH"
              git checkout "$BRANCH"
              git pull origin "$BRANCH"
            fi

            echo "ğŸ”¨ Building Docker image..."
            docker compose -f docker/docker-compose.ecs.yaml build --no-cache api

            echo "ğŸš€ Restarting services..."
            docker compose -f docker/docker-compose.ecs.yaml up -d --remove-orphans

            # ç­‰å¾…æœåŠ¡å¯åŠ¨å¹¶æ£€æŸ¥å¥åº·çŠ¶æ€
            echo "â³ Waiting for API to be healthy..."
            for i in $(seq 1 30); do
              if docker compose -f docker/docker-compose.ecs.yaml exec -T api wget -q --spider http://localhost:3000/api 2>/dev/null; then
                echo "âœ… API is healthy!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ API health check failed after 30 attempts"
                docker compose -f docker/docker-compose.ecs.yaml logs api --tail=50
                exit 1
              fi
              echo "  Attempt $i/30..."
              sleep 5
            done

            # æ¸…ç†æ—§é•œåƒ
            docker image prune -f

            echo "âœ… Deployment completed!"
            echo "ğŸ“Œ Version: $(git describe --tags --always)"
